<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV M3U Generator</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        tr {
            cursor: pointer;
        }
        tr:hover {
            background-color: #f2f2f2;
        }
        .selected {
            background-color: #add8e6 !important;
        }
       
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            text-align: center;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h2>Select a Service</h2>
    <table border="1">
        <thead>
            <tr>
                <th>ID</th>
                <th>Service</th>
                <th>Countries</th>
                <th>Main Categories</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

<div id="myModal" class="modal">
    <div class="modal-content">
        <div class="tab">
            <div id="tab-m3u" class="active" onclick="switchTab('m3u')">M3U</div>
            <div id="tab-xtream" onclick="switchTab('xtream')">Xtream</div>
        </div>
    
        <!-- Tab para ingresar solo la URL de M3U -->
        <div id="m3u-content" class="tab-content active">
            <h3>Enter M3U URL</h3>
            <label>M3U URL: <input type="text" id="m3uUrl"></label><br><br>
            <button onclick="submitM3U()">Generate M3U</button>
        </div>
    
        <!-- Tab para ingresar Xtream Credentials -->
        <div id="xtream-content" class="tab-content">
            <h3>Enter Xtream Credentials</h3>
            <label>DNS: <input type="text" id="dnsX"></label><br>
            <label>Username: <input type="text" id="usernameX"></label><br>
            <label>Password: <input type="password" id="passwordX"></label><br>
            <button onclick="submitForm()">Generate Xtream</button>
        </div>

      </div>
    </div>

     <div id="NextSteps" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Next Steps</h3>
            <label>
                    1. Use a USB (or buy an OTG Cable for firestick users) and move the edited M3U file from the USB to the device you want to use (Nvidia Shield for example).

                    2. Insert the USB with the edited M3U file in the streaming device

                    3. Open TiviMate and go to "Settings"

                    4. Select "Playlists"

                    5. Select "Add Playlist'

                    6. Select "M3U playlist"

                    7. Click "Select Local Playlist"

                    8. Click the USB Drive and select the modified .M3U file 

                    9. When asked for an EPG URL Enter this:
            </label> <label id="EPG"> </label><br>
            10. If you want to enter the EPG in your own IPTV Editor, use this as an external EPG:
            <label id="GitHub_EPG"> </label>
            <br>
        </div>
    </div>

    <input type="hidden" id="selectedID">
    <input type="hidden" id="m3uUrl">
    <input type="hidden" id="dns">
    <input type="hidden" id="username">
    <input type="hidden" id="password">

    <script>

    <script>
        function switchTab(tab) {
            document.getElementById("m3u-content").classList.remove("active");
            document.getElementById("xtream-content").classList.remove("active");
            document.getElementById("tab-m3u").classList.remove("active");
            document.getElementById("tab-xtream").classList.remove("active");

            document.getElementById(`${tab}-content`).classList.add("active");
            document.getElementById(`tab-${tab}`).classList.add("active");
        }
        const CSV_URL = "https://docs.google.com/spreadsheets/d/1JZ3K-7VKtXdZfnqcUBU2Mv2cGKwgWa73NACNQFrylD4/gviz/tq?tqx=out:csv"; 

        async function loadCSV() {
            try {
                let response = await fetch(CSV_URL, { redirect: "follow" });
                if (!response.ok) throw new Error("Failed to fetch CSV file");

                let text = await response.text();
                let rows = text.split("\n").slice(1);
                let tableBody = document.getElementById("tableBody");

                rows.forEach(row => {
                    let columns = row.split(",");
                    if (columns.length >= 5) {
                        let newRow = document.createElement("tr");
                        newRow.innerHTML = `
                            <td>${columns[0]}</td>
                            <td>${columns[1]}</td>
                            <td>${columns[2]}</td>
                            <td>${columns[3]}</td>
                        `;
                        newRow.onclick = () => selectRow(newRow, columns[0], columns[4], columns[5], columns[6]);
                        tableBody.appendChild(newRow);
                    }
                });
            } catch (error) {
                console.error("Error loading CSV:", error);
            }
        }

        function selectRow(row, id, url, epg, GitHub_EPG) {
           
            document.querySelectorAll("tr").forEach(tr => tr.classList.remove("selected"));
            
            
            row.classList.add("selected");

            
            document.getElementById("selectedID").value = id;
            document.getElementById("m3uUrl").value = url;
            document.getElementById("EPG").value = epg;
            document.getElementById("GitHub_EPG").value = GitHub_EPG;

            
            document.getElementById("credentials").style.display = "block";
        }

        function closeModal() {
            document.getElementById("credentials").style.display = "none";
            document.getElementById("NextSteps").style.display = "block";
        }
        
        function extractM3UDetails(m3uUrl) {
            try {
                let url = new URL(m3uUrl);
                let params = new URLSearchParams(url.search);
        
                let username = params.get("username");
                let password = params.get("password");
                let dns = `${url.protocol}//${url.host}`; // Extrae solo el dominio
        
                if (!username || !password) {
                    return null;
                }
        
                document.getElementById("dnsX").value = dns;
                document.getElementById("usernameX").value = username;
                document.getElementById("passwordX").value = password;
                
                return submitForm();
            } catch (error) {
                console.error("Error extracting M3U details:", error);
                return null;
            }
        }
        
        function submitForm() {
            let dns = document.getElementById("dns").value;
            let username = document.getElementById("username").value;
            let password = document.getElementById("password").value;
            let selectedID = document.getElementById("selectedID").value;
            let m3uUrl = document.getElementById("m3uUrl").value;

            if (!selectedID || !dns || !username || !password) {
                alert("Please fill in all fields.");
                return;
            }

            alert(`Processing M3U file for ID: ${selectedID} with DNS: ${dns}`);

            const postData = {
                id: selectedID,
                dns: dns,
                username: username,
                password: password,
                m3uUrl: m3uUrl
            };

            fetch('https://repository-server.onrender.com/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(postData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                const link = document.createElement('a');
                const url = window.URL.createObjectURL(blob);
                link.href = url;
                link.download = `modified_playlist_${selectedID}.m3u`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
                closeModal(); 
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error processing M3U file');
            });
        }

        loadCSV();
    </script>
</body>
</html>
